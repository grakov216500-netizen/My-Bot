# Переход на отдельный сайт ВИТЕХ (без Mini App)

## Цель
Отдельный сайт: все данные подаются сержантами/системой, связи с Telegram Mini App как таковой нет. Полноценный переход на новую базу и один фронт.

---

## 1. Исправление 404 при открытии с `/site/`

**Причина:** Страница открывается по адресу `http://localhost:8000/site/`. Относительный путь `api/schedule/today` превращался в `http://localhost:8000/site/api/...` → 404.

**Сделано:** В `site/app.js` — `API_BASE = window.location.origin` если путь содержит `/site`. Все запросы идут на `origin + '/api/...'`.

**Сделано (дополнительно):** При отсутствии APEX_USER/APEX_PASS сервер теперь возвращает пустые данные с сообщением вместо 503/500. Исправлен синтаксис в `apex_parser.py` (`def create_default_parser() -> ...`).

**Статус: ✅ Готово**

---

## 2. Расписание (Apex ВУЗ)

**Откуда данные:** Парсинг с Apex ВУЗ (`apex_parser.py`). Эндпоинты `/api/schedule/today`, `/api/schedule/week`.

**Вход на сайт:** При заходе на сайт — ввод Telegram ID + группа + год набора. Группа и год сохраняются в localStorage и используются для загрузки расписания.

**Главное меню (упрощённый блок):** ✅ Реализовано
- Карточка расписания на всю ширину, по центру.
- Таблица: номер пары (1, 2, 3, 4), дисциплина, вид занятия, аудитория (только номер — 2503, не «2 кор./2503»), преподаватель.
- Не выводит: время (все знают), группу в каждой строке, лишние колонки.
- Если пар нет — соответствующее сообщение.
- В выходные показывает расписание понедельника.

**Модуль «Учёба»:** ✅ Боковая панель с разделами
- **Расписание** — недельное с навигацией Пред./След. неделя.
- **Поиск по дате** — выбор даты открывает нужную неделю.
- **Журнал** — заглушка (ждёт данные Апекс).
- **Пропуски** — заглушка (только активные, что нужно исправить).
- **Библиотека** — облака/ссылки преподавателей (заглушка).
- **Тренажёр** — тесты по предметам, прогресс (заглушка, очки за тесты → рейтинг).

**Статус: ✅ Готово (расписание работает, остальные разделы — каркас)**

---

## 3. Наряды

**Откуда данные:** Всё загружают сержанты (график .xlsx). Не загружаем «откуда-то».

**Реализовано:**
- Раздел «График» — ближайший наряд, загрузка .xlsx, месяцы, бригада по дате.
- Раздел «Шаблон» — скачать общий/групповой шаблон, загрузить свой (сержант).
- Раздел «Опрос» — ссылка на опросы.
- Раздел «Правки / замены» — каркас.
- Эндпоинты `GET /api/schedule/template?telegram_id=...`, `POST /api/schedule/upload-template`.

**Статус: ✅ Готово**

---

## 4. Рейтинг

**Реализовано:**
- В главном меню — мини-блок с аватаром и очками, кнопка «Весь рейтинг →».
- Полная страница рейтинга с фильтрами: Курс / Институт, Всё время / Месяц.
- Карточки курсантов: ранг, аватар (из загрузки или ui-avatars), ФИО, группа, очки.
- **Топ 1–3 — анимированная рамка** (золото, серебро, бронза, пульсация).
- Аватары из загруженных пользователями файлов (`/api/profile/avatar`).
- Эндпоинт `GET /api/rating/top-enhanced` с аватарами.

**В планах:** статистика по карточке (клик), «за сегодня +12» зелёным, связь с тестами/материалами.

**Статус: ✅ Основа готова**

---

## 5. Профиль

**Реализовано — полная страница профиля:**
- Большой аватар с кнопкой редактирования (загрузка через `POST /api/profile/avatar`).
- Фиксированные данные: ФИО, группа, курс, роль.
- Статистика: очки рейтинга, количество нарядов.
- **Больничный** — форма «с — по» (два поля дат), сохранение в БД (`POST /api/profile/sick-leave`).
- **Достижения** — сетка с иконками, разблокированные/заблокированные.
- Кнопка «Админ-панель» для админа.

**Статус: ✅ Готово**

---

## 6. Выбор группы при заходе

**Реализовано:**
- На экране входа — три поля: Telegram ID, Группа, Год набора.
- Значения сохраняются в localStorage.
- При наличии профиля в БД — группа подтягивается оттуда.

**Статус: ✅ Готово**

---

## 7. Новые API эндпоинты

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/profile/full` | GET | Полная информация профиля (аватар, достижения, больничные, статы) |
| `/api/profile/avatar` | POST | Загрузка аватара |
| `/api/profile/avatar/{id}` | GET | Получение аватара |
| `/api/profile/sick-leave` | POST | Добавить больничный с-по |
| `/api/groups/list` | GET | Список групп из кэша Апекс или БД |
| `/api/schedule/today-by-group` | GET | Расписание по группе без telegram_id |
| `/api/schedule/week-by-group` | GET | Недельное расписание по группе |
| `/api/rating/top-enhanced` | GET | Рейтинг с аватарами |
| `/uploads/avatars/...` | Static | Статика загруженных аватаров |

**Статус: ✅ Готово**

---

## 8. Что ещё сделать

| № | Задача | Статус |
|---|--------|--------|
| 1 | Исправить API_BASE при открытии с `/site/` | ✅ Сделано |
| 2 | Исправить синтаксис apex_parser.py | ✅ Сделано |
| 3 | Graceful handling при недоступном Apex | ✅ Сделано |
| 4 | Выбор группы при заходе на сайт | ✅ Сделано |
| 5 | Упрощённый вывод расписания на главной | ✅ Сделано |
| 6 | Шаблон для группы (сержант) | ✅ Сделано |
| 7 | Полная страница профиля (аватар, больничный, достижения) | ✅ Сделано |
| 8 | Рейтинг с аватарами, фильтрами, анимацией топ-3 | ✅ Сделано |
| 9 | Модуль Учёба с боковой панелью (6 разделов) | ✅ Каркас |
| 10 | Клик по паре → прикрепление материалов | К реализации |
| 11 | Журнал/Пропуски из Апекс | После ответа Apex |
| 12 | Тренажёр (тесты по предметам, очки → рейтинг) | К реализации |
| 13 | Библиотека (ссылки преподавателей) | К реализации |
| 14 | Статистика по карточке курсанта в рейтинге | К реализации |
| 15 | «За сегодня +12» в рейтинге | К реализации |
| 16 | Онлайн-статус | К реализации |
| 17 | PostgreSQL переход | Когда готов |

---

## 9. Запуск и проверка

1. `python server.py` или `uvicorn server:app --host 0.0.0.0 --port 8000`.
2. Открыть `http://localhost:8000/site/`.
3. Ввести Telegram ID (из БД), группу (Ио6-23), год (2023).
4. Проверить в Network (F12): запросы на `http://localhost:8000/api/...` → 200.
5. Если Apex не настроен — расписание покажет «Сервис недоступен», наряды и рейтинг покажут данные из БД.
