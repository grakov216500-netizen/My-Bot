# План доработок (структура, без реализации)

Краткий план, чтобы не потерять идеи. Реализация — по шагам.

---

## 1. Опрос (реализовано)

- **Этап 1**: 6 пар основных нарядов (Курс, ГБР, Столовая, ЗУБ). В каждой паре подпись «A vs B» и вопрос «Какой наряд сложнее?»
- **Этап 2**: 6 объектов столовой (Горячий цех, Овощной цех, Стаканы, Железо, Лента, Тарелки) — **13 случайных пар**. Вопрос «Какой объект сложнее?» (сравниваем объекты, не наряды).

---

## Напоминания о задачах (как работают)

- Напоминание **отправляет Telegram-бот** в момент времени `deadline` (файл `handlers/task_reminders.py`).
- Приложение только сохраняет `deadline` через API; бот при запуске восстанавливает отложенные напоминания (`restore_task_reminders`) и раз в 30 сек проверяет задачи (`check_task_reminders`).
- Если сообщение не приходит: 1) бот должен быть запущен; 2) job_queue активна; 3) пользователь не блокировал бота; 4) **время на сервере** — напоминание срабатывает в момент дедлайна по времени сервера (где крутится бот). Например, если завести 00:30, напоминание придёт когда на сервере будет 00:30. Окно проверки расширено до ±60 сек.

---

## 2. Отдельный опрос для девушек (план)

- В регистрации уже есть **пол (женский)** — по нему отсев: девушки не участвуют в опросе юношей.
- У девушек **3 наряда**: ПУТСО, Столовая, Медчасть.
- Схема та же: попарное сравнение, все возможные пары (3 пары).
- Отдельный «опросник» для женского пола, те же механики (веса, рейтинг).

---

## 3. Модуль «Опрос» (полноценная функция — план)

- **Активные опросы**: видны списком.
  - Системные (для работы нарядов): опрос юношей, опрос девушек — всегда 2 таких.
  - Дополнительные: может создать **сержант** (для своей группы) или **помощник** (для всего курса).
- Немного «демократии», но без перебора.
- **Завершение опроса**: результат показывается, когда опрос считается завершённым.
  - Кто может завершить досрочно (например, помощник/админ).
  - Возможность задать время окончания опроса.
- **Визуализация результатов**: что кому присвоено, сколько голосов, гистограмма и т.п. — после завершения.

---

## 4. Роли и панели (реализовано в Mini App)

- **Профиль**: в шапке выводится ФИО, курс, группа, **роль** (Курсант / Сержант / Помощник / Администратор). По нажатию на аватар/блок с данными открывается экран **«Мои данные»**: редактирование ФИО и группы, кнопки «Админ-панель» (для админа) и «Панель помощника» (для помощника).
- **Админ-панель**: список зарегистрированных пользователей; фильтр по курсу (год набора), поиск по ФИО; назначить помощником, назначить сержантом, снять должность.
- **Панель помощника**: тот же список (в рамках своего курса), только назначение/снятие **сержанта** (помощника назначает только админ).
- **Завершение опроса**: в разделе «Опрос» у админа и помощника отображается блок «Завершить опрос» — подсчёт весов и завершение текущего раунда (API `POST /api/survey/finalize`).

| Роль      | Где в интерфейсе | Функции |
|----------|-------------------|---------|
| **Админ** | Профиль → Админ-панель | Список пользователей (курс, группа, поиск по ФИО), назначение/снятие помощника и сержанта. |
| **Помощник** | Профиль → Панель помощника | Список пользователей своего курса, назначение/снятие сержанта. |
| **Сержант** | Отдельной панели нет. | Только в разделе **Наряды**: загрузка/редактирование графика для своей группы. |

---

## 5. Доработки (сделано в этой итерации)

- **Мои данные**: по умолчанию свёрнуты; по клику «▶ Развернуть» показываются поля и кнопки.
- **Опрос**: отступ сверху (padding-top), чтобы шапка не загораживала контент.
- **После завершения опроса**: у того, кто нажал «Завершить опрос», автоматически обновляются главная и виджет; в тосте выводится «Проголосовало: N чел.».
- **Виджет «Ближайший наряд»**: если график не загружен, но опрос уже завершён (есть голоса), показывается «Опрос завершён. Результаты на главной.» и «Проголосовало: N чел.».
- **Вес без голосов**: объекты, которые ни разу не выбирали как тяжёлые, получают коэффициент 0.8 и 8 баллов; в результатах отображается подпись «(коэфф. 0.8, 8 баллов)».

---

## 6. Дальше по плану

- **Отдельная вкладка «Опрос»**: не только прохождение, но и список системных опросов + создание опроса (сержант — для группы, помощник — для курса). Завершать досрочно или по времени может только создатель.
- **Загрузка графика внутри приложения**: да, это возможно — в Mini App кнопка «Загрузить график», выбор файла (input type=file), отправка на сервер (multipart/form-data), парсинг .xlsx на бэкенде (логика уже есть в excel.py). Сержант/помощник/админ видят окно с описанием шаблона и загрузкой файла.
- **Результаты опроса визуально**: после «опрос завершён» — перелистывание карточек с процентным соотношением ответов (A сложнее / равно / B сложнее) по парам, без гистограммы.
- **Наряды**: после расчёта весов — полноценный интерфейс: когда наряд, с кем, поиск по дате, пролистывание месяцев, статистика.
- **Опрос для девушек**: отдельный опросник (ПУТСО, Столовая, Медчасть), отсев по полу в регистрации.

---

*Документ обновлён. Реализация — поэтапно.*
