# Задачи: переход на сайт и улучшение системы образования

Структурированный план без привязки к ответу Apex (гибридный переход), плюс видение образовательного модуля и минимализма.

---

## Часть 1. Консоль и стабильность

### 1.1. «Спам» в консоли (viewport_changed)

- **Что видно:** сотни сообщений `[Telegram.WebView] < receiveEvent viewport_changed Object`.
- **Причина:** это не ошибки приложения, а события от **Telegram WebApp SDK** (telegram-web-app.js). При изменении размера/прокрутке клиент шлёт viewport_changed, и они все логируются.
- **Что сделать:** в продакшене в DevTools можно отключить/фильтровать логи по «viewport». Со стороны кода мы не управляем логированием чужого скрипта. Критичных действий не требуется.

### 1.2. Ошибки через ~10 минут (ERR_CONNECTION_TIMED_OUT)

- **Что видно:** `Failed to load resource: net::ERR_CONNECTION_TIMED_OUT` на запросы к `vitechbot.online/api/...` (duties, tasks, survey/list и т.д.).
- **Причина:** сервер перестаёт отвечать вовремя (обрыв сети, перезапуск, таймаут на хостинге, падение процесса).
- **Что сделать:**
  - Со стороны **сервера:** проверить логи и стабильность процесса (systemd, рестарты, лимиты памяти), при необходимости увеличить таймауты и keep-alive.
  - Со стороны **клиента:** при `Failed to fetch` / таймауте показывать «Проверьте соединение» и делать 1–2 повтора запроса с задержкой (**сделано:** в `app/script.js` добавлен `fetchWithRetry` для загрузки профиля, задач, нарядов, расписания на сегодня, уведомлений).

---

## Часть 2. Шаблон графика и опрос для девушек

### 2.1. Шаблон графика (.xlsx)

- **Задача:** использовать обновлённый шаблон (больше строк, роли для девушек).
- **Сделано в коде:**
  - Путь к шаблону задаётся через переменную окружения `SCHEDULE_TEMPLATE_PATH` (если не задана — используется файл в корне проекта или запасная генерация).
  - Парсер поддерживает больше строк по ФИО (например 6–55 вместо 6–40), чтобы не обрезать большие группы.
- **Вам:** положить актуальный файл `Шаблон.xlsx` в папку проекта (или указать полный путь в `SCHEDULE_TEMPLATE_PATH`) и перезапустить сервер.

### 2.2. Опрос для девушек

- **Было:** ПУТСО, Столовая, Медчасть (3 объекта).
- **Стало:** Столовая, ПУТСО, Медчасть, **ОТО** (отдел тылового обеспечения) — 4 объекта, 6 пар сравнений.
- В БД и логике опроса добавлен объект ОТО в блок «Опрос девушек».

---

## Часть 3. Гибридный переход на сайт (пока без Apex)

### 3.1. Цель

- Сайт — основной интерфейс (минимализм, надёжность, удобство).
- Telegram-бот — прототип мобильного приложения и запасной канал.
- После ответа от Apex — добавить вход «через Apex ВУЗ» на сайте.

### 3.2. Практические шаги (по порядку)

| № | Задача | Комментарий |
|---|--------|-------------|
| 1 | **Отдельный фронт для сайта** | Вынести или продублировать текущий Mini App (HTML/JS/CSS) в отдельный проект/репозиторий, который открывается по домену сайта (не только через Telegram). Тот же API (vitechbot.online). **Сделано:** папка `site/` с главной «Мой день»; при запуске сервера сайт доступен по адресу `/site/` (например `http://localhost:8000/site/`). |
| 2 | **Страница входа** | Для сайта без Apex: форма «Логин + пароль» или «Вход по Telegram» (ссылкой из бота). После проверки — выдача сессии/JWT и редирект в личный кабинет. |
| 3 | **Единый API** | Один backend (FastAPI) для бота и сайта. По возможности один и тот же домен API (vitechbot.online), чтобы не плодить CORS и таймауты. |
| 4 | **Главная сайта** | Минимум: фон (институтский или нейтральный), короткий текст «для чего этот сайт» и предыстория, кнопка «Войти». Без лишних виджетов — в духе Cursor: мало элементов, только нужное. |
| 5 | **HTTPS** | На сайте института нет безопасного соединения — ваш сайт должен работать по HTTPS (Let's Encrypt и т.п.), чтобы логины и данные не передавались открытым текстом. |
| 6 | **После ответа Apex** | Добавить кнопку «Войти через Apex ВУЗ», редирект на их страницу входа (или их API), возврат с токеном/кодом, получение ФИО/группы/курса и создание сессии на вашей стороне. |

### 3.3. Что не трогать до ответа Apex

- Не реализовывать «полную» интеграцию с Apex (пароль не хранить, не эмулировать их форму входа).
- Вопросы для IT/преподавателя уже сформулированы в **APEX-API-QUESTIONS.md**.

---

## Часть 4. Образовательный модуль и минимализм

### 4.1. Критика текущего Apex (ваши тезисы)

- Набор лишней информации: неуды за прошлый семестр рядом с изменением расписания, «Обращения» (никто не пользуется), старые объявления после прочтения — пустота.
- Электронный журнал / Мои оценки: непонятный набор недель (1–52), 5 лишних колонок (всего оценок, отличных, положительных, неуд., пропусков) — для курсанта достаточно видеть сами оценки; сводки оставить для ведомостей отдельно.
- Расписание: не показывать первый курс третьему, не показывать факультет внебюджета и т.п. — только свой курс (например 2023 набора), инж/юр.

### 4.2. Принципы вашего интерфейса

- **Минимализм и нужность:** только то, что нужно сейчас (расписание на день/неделю, свои оценки, свои пропуски).
- **Удобство выбора недели:** по дате или «текущая / следующая / предыдущая», без полосы из 52 цифр.
- **Расписание:** понедельник–пятница (суббота/воскресенье не показывать, если не рабочие; если в Apex есть занятие в сб — тогда показывать).
- **Мотивация:** не «93000 материалов в свободном доступе», а цель, прогресс, рейтинг, награды — как в старых обучающих сайтах с курсами и соперничеством.

### 4.3. Задачи по модулю «Учёба» (после появления доступа к данным)

| № | Задача | Комментарий |
|---|--------|-------------|
| 1 | **Расписание на неделю** | Вывод только своего курса (год набора), Пн–Пт, выбор недели по дате или кнопкам «текущая / ±1 неделя». |
| 2 | **Расписание на 1 день** | Уже есть в главном меню бота — на сайте оставить такой же блок «сегодня» для быстрого просмотра (аудитория, пара). |
| 3 | **Учебный дневник** | Оценки и пропуски без лишних колонок: предмет, дата, оценка/статус (и при необходимости пометка «пропуск»). Сводки «всего/отличных/неуд» — отдельно, для ведомостей или по явному запросу. |
| 4 | **Материалы по предмету** | По нажатию на предмет в расписании — материалы, присланные одногруппниками; при желании привязать к рейтингу активности на сайте. |
| 5 | **Роль «журналист»** | Выгрузка оценочной ведомости с пропусками по предметам (шаблон/формат отдельно, не усложнять интерфейс курсанта). |

Реализация — после ответа Apex (API или выгрузки) и уточнения форматов данных.

---

## Часть 5. Заметки (задачник) — идеи по улучшению

- Сейчас: поиск, активные/выполненные, добавление, выполнение — минимально и понятно.
- В духе Notion/современных планировщиков (без перегруза):
  - **Категории/теги:** личное, учёба, наряд — фильтр по ним.
  - **Краткие карточки:** заголовок + описание + дата (как в карточках Notion), без лишних колонок.
  - **Прогресс:** простой индикатор «выполнено за неделю» или «цель на месяц» (связь с мотивацией и наградами).
- Не делать «93000 материалов»: ограничиться простым списком задач с минимальным набором полей и, при желании, одной–двумя иконками/иллюстрациями для типов задач (учёба, наряд, личное).

---

## Часть 6. Итоговый порядок работ

### Сейчас (без Apex)

1. Стабильность: retry при таймауте API, сообщение «Проверьте соединение».
2. Шаблон графика: путь из env, парсер с большим числом строк; раздать обновлённый .xlsx пользователям.
3. Опрос для девушек: Столовая, ПУТСО, Медчасть, ОТО.
4. Подготовка к сайту: отдельная точка входа (страница логина + главная), тот же API, HTTPS.

### После ответа Apex

5. Вход «через Apex ВУЗ» на сайте.
6. Расписание и дневник из данных Apex (форматы уточнить по ответам из APEX-API-QUESTIONS.md).
7. Модуль «Учёба» по шагам из п. 4.3.

### Параллельно (по желанию)

8. Улучшение заметок: теги, карточки, простой прогресс.
9. Мотивация: цели, рейтинг активности, награды за учёбу/сайт.

Документ можно дополнять и переносить выполненные пункты в «Сделано».
