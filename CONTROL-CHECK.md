# Контрольная проверка разработки — электронный помощник курсанта

Документ фиксирует сделанные правки, идеи и дальнейшие шаги: косметика, баги, рейтинг, оповещения, учёба, миграция на сайт и приложение.

---

## 1. Что уже сделано в этой сессии

### Косметика и тексты
- **Приветствие (не зарегистрирован):** сокращено до краткого варианта в `utils/welcome_message.py` — «Электронный помощник курсанта», один абзац про факультеты/курс, кнопка «Регистрация». Развёрнутый текст вынесен в `get_welcome_message_long()` для мини-приложения при необходимости.
- **График:** убрана отдельная кнопка «Шаблон»; остались только **«Загрузить график»** и **«Редактирование»**. Скачать шаблон можно по ссылке внутри блока загрузки. Увеличены отступы (gap 16px, margin 20px), размер кнопок и шрифтов (14–15px, padding 14px 22px), добавлен отступ между ссылкой «Скачать шаблон» и полем выбора файла, чтобы меньше путать с кнопкой «Загрузить».

### Исправленные баги
- **Опросы — крестик выхода:** в шапке экрана «Опросы» кнопка ✕ теперь вызывает `closeSurveyScreen()` и полностью закрывает раздел опросов с возвратом на главную. Раньше вызывался только `showSurveyList()`, из-за чего «крестик не нажимался» в смысле выхода из опроса.
- **Календарь нарядов — подсветка дня:** при выборе даты в календаре теперь подсвечивается именно выбранный день (фиолетовый), а не только сегодня. Добавлена переменная `selectedCalendarDay`, сброс при смене месяца/года.
- **Опросы — структура завершения:** убрана кнопка «Завершить (столовая)». Остались два этапа: **«Завершить (парни)»** и **«Завершить (девушки)»**. Столовая входит в опрос для парней (main), отдельное завершение по столовой не нужно.

---

## 2. Миграция с Telegram: сайт и приложение

### Контекст
Telegram в РФ может стать ограниченной платформой — логично иметь основной канал доступа вне зависимости от мессенджера.

### Предлагаемая последовательность
1. **Сайт (веб)** — первый приоритет:
   - Единый фронт (адаптивный) для курсантов: наряды, график, задачи, опросы, рейтинг, позже учёба.
   - Авторизация: см. раздел про институтский логин ниже.
   - API уже есть (FastAPI в `server.py`); фронт можно развивать в `app/` или вынести в отдельный SPA (React/Vue) с тем же API.

2. **Полу-офлайн приложение** — второй шаг:
   - Данные с сервера (график, мои наряды, задачи) кэшируются локально.
   - При наличии сети — синхронизация; без сети — работа по кэшу (просмотр, добавление задач с последующей синхронизацией).
   - Технологии: PWA (тот же сайт как приложение) или оболочка (Capacitor / React Native) поверх веб-клиента.

3. **ВК и другие платформы** — по желанию:
   - Мини-приложение ВК может вызывать тот же API, что и сайт; логика дублируется по минимуму.

### Авторизация через институтский портал (Apex)
- Идея: вход по логину/паролю института (Apex) вместо «кто угодно регистрируется в боте».
- Плюсы: только лица с доступом к Apex получают доступ; автоматически известны ФИО, курс, группа — не нужен ручной ввод и совпадение ФИО для парсинга графика.
- Реализация упирается в то, есть ли у института **OAuth/SSO или API** для проверки логина/пароля и выдачи данных пользователя. Варианты:
  - Интеграция с существующей системой (если есть OAuth2/OpenID) — на сайте кнопка «Войти через портал института», редирект на институтский провайдер, после входа получаете идентификатор и, по возможности, ФИО/группу/курс.
  - Если только логин/пароль без API: отдельный сервис института, который по запросу проверяет учётные данные и возвращает минимальный профиль (без хранения пароля у вас). Без поддержки со стороны института безопасно «проверять пароль» у себя нельзя.
- Рекомендация: уточнить в учебном отделе / IT института, есть ли возможность входа по учётной записи (OAuth, API, или доверенный сервис проверки). От этого зависит, делаем ли «Войти через институт» или пока оставляем регистрацию по ФИО/группе с последующим переходом на институтский вход при появлении API.

---

## 3. Безопасность и база данных

- **Сейчас:** SQLite (`bot.db`) — удобно для одного процесса и малых объёмов, но при переходе на сайт и несколько воркеров лучше разделить: один процесс на запись или использование серверной СУБД.
- **Переход:** для продакшена с ростом нагрузки и централизованной авторизацией логичен шаг на **PostgreSQL** (или MySQL): нормальная работа с подключениями, бэкапы, при необходимости шифрование диска и доступ по SSL. Миграции из SQLite в PostgreSQL делаются выгрузкой схемы и данных (например, через `pgloader` или свои скрипты).
- **Секреты:** токены и пароли — только в переменных окружения (или секретное хранилище), не в коде и не в репозитории.
- **Данные пользователей:** при институтской авторизации хранить только то, что нужно для работы (идентификатор, ФИО, группа, курс, роль); лишние поля не собирать.

---

## 4. Рейтинг и достижения (идеи для реализации)

### Рейтинг
- **Источник очков:** веса из опроса (расценки нарядов); начисление баллов за выполненный наряд по объекту/роли (уже заложено в логике весов и распределения).
- **Отображение (по аналогии с VK Шаги):**
  - Топ за месяц: по курсу и общий по институту.
  - Топ за всё время: по курсу и по институту.
  - В профиле: количество очков, место в топе (цифра под аватаркой или рядом).
- **Учёт курсов:** при общем рейтинге института учитывать, что расценки (веса) могут отличаться по курсам — сравнивать в рамках одной «лиги» (курс) или нормализовать очки (например, делить на средний вес наряда по курсу).
- **Реализация:** таблицы/поля под рейтинг (очки за период, место), API эндпоинты (топ за месяц/всё время по курсу/институту), виджет на главной и экран рейтинга в приложении.

### Достижения (награды)
- Фиксированный набор: иконка + название + описание (например: «Первые 10 нарядов», «Месяц без пропусков», «Топ-3 курса»).
- При выполнении условия (проверка по БД/баллам) — достижение открывается, отображается в «Мои награды».
- Можно показывать редкость: «такой медалью обладают 3% института» (процент от числа зарегистрированных).
- Картинки/иконки — статичные файлы на сервере или в приложении; генерацию «смешных образов» можно вынести в отдельный контур (другая модель/дизайн), как вы и планировали.

---

## 5. Оповещения (система уведомлений)

### Роли и кто что видит
- **Курсант:** на главном экране — блок «Изменения в графике» (что изменилось: кому добавлен/снят наряд, дата). По нажатию — текст изменений. Плюс колокол (значок) для своих напоминаний (личные задачи/наряды).
- **Сержант:** колокол — «Напоминания для своей группы»: создаёт напоминания только по своей группе; при изменении графика курсантам группы уходит уведомление вида «Сержант ФИО: График изменён 15.02» с возможностью раскрыть детали (например, «у такого-то ФИО добавлен наряд»).
- **Админ:** системные объявления (модернизации, важная информация для всех).
- **Помощник (курс):** рассылка оповещений по своему курсу.

### Технически
- Хранить «события» изменений графика (кто, когда, что изменено) и список рассылки по ролям/группам/курсу.
- При открытии главного экрана — запрос «непрочитанных» уведомлений для пользователя; после просмотра — помечать прочитанными.
- Для Telegram-бота — по возможности дублировать критические уведомления в чат (как сейчас напоминания о нарядах); для сайта/приложения — показ в интерфейсе и при желании push (PWA) или позже в нативном приложении.

---

## 6. Опросы: доработки (без кода, только идеи)

- **Таймер 2 дня:** старт отсчёта с момента первого проголосовавшего — сохранять в БД время первого голоса по этапу опроса и считать «опрос открыт до start + 2 дня».
- **Закрытие на месяц (парни/девушки):** после завершения этапа опрос закрыт до следующего периода (например, +1 месяц); при входе показывать «Вы уже проходили опрос, результаты ниже» и блок с результатами (если админ/помощник уже подвёл итоги).
- **Завершение системных опросов помощником:** роль `assistant` (или отдельный флаг) — право вызывать «Завершить (парни)» / «Завершить (девушки)» для масштаба ~500 человек без обязательного админа.
- **Результаты — прозрачность:** сначала экран «итог» (основные наряды: курс X баллов, столовая Y; по объектам столовой — ГЦ, Железо, Лента и т.д. с коэффициентами и баллами; ограничения: столовая кф 1.6, не ниже 0.8; основные не выше 2, не ниже 0.9). Кнопка «Подробнее» — развёрнутый расчёт по каждому объекту (как считались коэффициенты, формула баллов от базовой ставки), чтобы было понятно, что оценка от задействованности, а не от «прихоти».

---

## 7. Наряды: смены, календарь, редактирование (размышления)

### Смены (распределение по сменам)
- **Курс:** ручное редактирование сержантом с указанием причины; выбор кто в какую смену.
- **ГБР:** автоматически по 2 человека на смену (1, 2, 3), рандом среди тех, кто в наряде в этот день.
- **Интерфейс «Смены»:** можно визуализировать: пустые слоты до момента распределения (например, за 3 часа до наряда — в 15:30); таймер «Распределение через …»; в момент распределения — анимация или пошаговое заполнение слотов (1-я смена, 2-я, 3-я). Это улучшает ожидание и понятность.
- Сейчас распределение в отдельной графе и не всегда совпадает с желаемой логикой — стоит держать «смены» именно в блоке «Мои наряды» (деталь по дате/роли), а в календаре — только «кто из группы в наряде в этот день» без разбивки по объектам/сменам.

### Календарь
- По нажатию на дату — показывать/подсвечивать **одногруппников** в этом дне (уже частично есть; убрать из календаря распределение по объектам, оставить список по ролям с акцентом на свою группу).
- Подсветка выбранного дня — уже исправлена (см. п. 1).

### Редактирование графика
- **Снять с наряда (убрать):** при выборе даты автоматически подставлять роль из графика по выбранному курсанту и дате; если наряда нет — показывать «Нет наряда для снятия». Поле «Роль» сделать только для отображения (фиксированное) при выборе даты и ФИО.
- **Замена:** вкладка «Замена» — интерфейс сделать прокручиваемым (overflow-y: auto), чтобы всё помещалось на экран без обрезки.

---

## 8. Модуль «Учёба» (направление разработки)

- **Ведомость пропусков:** автоматизация за счёт данных из Apex (выгрузка от преподавателей или API); сравнение с «системными» пропусками из графика нарядов и добавление последних в общую картину.
- **Роль «журналист»:** возможность выгружать оценочную ведомость с пропусками по предметам (по каждому предмету — шаблон или фиксированный формат).
- **Расписание в учёбе:** по неделям (фиксированные диапазоны, например 1–7 число), по месяцам; по нажатию на предмет — возможность прикрепить материал (лекция, конспект) от курсанта своей группы.
- **Дневник курсанта:** пропуски из Apex — красным; пропуски по графику нарядов (которых нет в Apex) — фиолетовым; по каждому — дата, вид занятия, примечание.

Сложность — интеграция с Apex (наличие API, форматы выгрузки, права доступа). Имеет смысл начать с ручного ввода/загрузки файлов по образцу Apex, затем при появлении доступа к API перейти на автоматическую синхронизацию.

---

## 9. Настройки и быстрая панель

- В настройках (три точки) — возможность менять состав быстрой панели: включать/выключать модули (заметки, опросы, учёба и т.д.), чтобы кому-то не показывать лишнее.

---

## 10. Ближайший наряд и переход в «Мои наряды»

- Сейчас при «наряд через 0 дней» информация выводится, но формулировка «через 0 дней» — некорректна. Сделать по нажатию на виджет «Ближайший наряд» переход в раздел «Мои наряды» с фокусом на этот наряд (или открытие детали наряда), чтобы не искать вручную.

---

## 11. Краткий чек-лист по приоритетам

| Задача | Статус |
|--------|--------|
| Приветствие короче, два опроса (парни/девушки), крестик опросов, календарь (подсветка дня), график (убрать Шаблон, отступы) | Сделано |
| Результаты опроса: итог + «Подробнее», ограничения кф, делегирование завершения помощнику | Идеи зафиксированы |
| Рейтинг: топ за месяц/всё время, по курсу/институту, очки и место в профиле | Идеи зафиксированы |
| Достижения: фиксированный набор, «Мои награды», процент обладателей | Идеи зафиксированы |
| Оповещения: изменения графика, колокол для сержанта, рассылка по курсу/админ | Идеи зафиксированы |
| Редактирование графика: авто-роль при снятии, прокрутка вкладки «Замена» | К реализации |
| Смены: интерфейс ожидания/распределения, таймер 15:30 | К реализации |
| Календарь: подсветка одногруппников по дате | К реализации |
| Миграция на сайт, авторизация через Apex, полу-офлайн приложение | План и условия описаны |
| Модуль учёба (ведомости, расписание, дневник) | Направление описано |

Документ можно дополнять по мере реализации пунктов и появления новых требований.

---

## 12. Вопросы для преподавателя (API Apex)

Отдельный файл **APEX-API-QUESTIONS.md** содержит:
- как думать о безопасности при интеграции с Apex;
- как объяснить преподавателю/IT, что нужно (если не знают термин «API»);
- **вопросы для записи**, если дадут добро на подключение:
  - **URL для запросов** (например: https://apex.vuz/api/v1/)
  - **Метод доступа** (GET или POST)
  - **Где передавать токен** (в заголовке или в ссылке)
  - **Лимиты** (сколько запросов в минуту можно делать)
  - **Формат ответа** (JSON или XML)

---

## 13. Что должно быть в плане на 100%

- **Наряды:** мои наряды, бригада, календарь по группе/курсу, загрузка и правка графика, распределение по сменам/объектам, напоминания.
- **Оценка сложности (опрос):** опрос для парней и для девушек, завершение этапов (без лишней кнопки «столовая»), таймер и результаты с прозрачным расчётом баллов.
- **Рейтинг:** очки за наряды по весам, топ за месяц/всё время по курсу и институту, место в профиле.
- **Достижения:** фиксированный набор наград, «Мои награды», процент обладателей.
- **Уведомления:** изменения графика (кто видит), колокол для сержанта (напоминания по группе), рассылка админа/помощника по курсу.
- **Задачи/заметки:** добавление, выполнение, поиск, напоминания по дедлайну.
- **Профиль:** данные курсанта, статистика нарядов, очки и место в рейтинге, больничные.
- **Настройки:** гибкая быстрая панель (включить/выключить модули).

---

## 14. Какие ещё модули могут помочь курсантам

- **Учёба** (отдельно): расписание пар, ведомость пропусков, материалы по предметам, дневник — после появления API Apex или ручного ввода.
- **Калькулятор нормативов:** ввод результатов (подтягивания, бег и т.д.) и сравнение с нормой по курсу/полу.
- **Справочник:** расписание звонков, контакты роты/курса, важные приказы и памятки в одном месте.
- **Обратная связь:** анонимные или подписанные сообщения руководству курса (если политика института разрешает).
- **Интеграция с институтским порталом (Apex):** единый вход, подтягивание ФИО/группы/курса и данных по учёбе — после ответов на вопросы из APEX-API-QUESTIONS.md.
